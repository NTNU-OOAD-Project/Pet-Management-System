<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¦ ç”¨å“å­˜è²¨ç´€éŒ„</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .item-card { min-height: 100px; }
    .hidden { display: none; }
  </style>
</head>
<body style="background-color: #f8f9fa;">

<div class="container py-5">
  <a href="/supply" class="btn btn-outline-secondary back-btn">â† è¿”å›å­˜è²¨æª¢è¦–</a>
  <div class="row g-4">

    <!-- ğŸ“¦ å·¦å´ï¼šç”¨å“æ¸…å–® -->
    <div class="col-md-6">
      <div class="card shadow p-3 rounded-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">ğŸ“¦ ç”¨å“å­˜è²¨ç´€éŒ„</h5>
          <button class="btn btn-sm btn-success" onclick="addItem()">â• æ–°å¢</button>
        </div>
        <div id="item-list">
          <!-- ç”¨å“é …ç›®æœƒåŠ åœ¨é€™è£¡ -->
        </div>
      </div>
    </div>

    <!-- ğŸ“‹ å³å´ï¼šè©³ç´°ç´€éŒ„ -->
    <div class="col-md-6">
      <div class="card shadow p-3 rounded-4 hidden" id="record-panel">
        <h5 class="mb-3"><span id="record-item-name">é …ç›®åç¨±</span> çš„å­˜è²¨ç´€éŒ„</h5>

        <!-- ç´€éŒ„è¡¨æ ¼ -->
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th>æ—¥æœŸæ™‚é–“</th>
              <th>æ•¸é‡</th>
              <th>å‚™è¨»</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="record-table-body">
            <!-- ç´€éŒ„åˆ— -->
          </tbody>
        </table>

        <!-- æ–°å¢ç´€éŒ„è¡¨å–® -->
        <div class="mt-3">
          <h6>æ–°å¢å­˜è²¨ç´€éŒ„</h6>
          <div class="row g-2">
            <div class="col-6">
              <input type="datetime-local" class="form-control" id="new-date">
            </div>
            <div class="col-3">
              <input type="number" class="form-control" id="new-quantity" placeholder="æ•¸é‡">
            </div>
            <div class="col-3">
              <input type="text" class="form-control" id="new-note" placeholder="å‚™è¨»">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-sm btn-primary" onclick="addRecord()">æ–°å¢ç´€éŒ„</button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  let currentEditingId = null; // ç›®å‰ç·¨è¼¯çš„åº«å­˜_idï¼Œnullä»£è¡¨æ–°å¢

  function addItem() {
    const container = document.getElementById("item-list");
    const div = document.createElement("div");
    div.className = "card mb-2 p-3 item-card";
    div.innerHTML = `
      <div class="row align-items-center">
        <div class="col-5"><input type="text" class="form-control" placeholder="é …ç›®åç¨±"></div>
        <div class="col-3"><input type="number" class="form-control" placeholder="åº«å­˜"></div>
        <div class="col-2"><input type="number" class="form-control" placeholder="è­¦æˆ’å€¼"></div>
        <div class="col-2 text-end">
          <button class="btn btn-sm btn-success me-1" onclick="saveItem(this)">ğŸ’¾å„²å­˜</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(this)">âŒåˆªé™¤</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  }

  function saveItem(button) {
    const itemCard = button.closest(".item-card");
    const inputs = itemCard.querySelectorAll("input");
    const itemName = inputs[0].value.trim();
    const quantity = parseInt(inputs[1].value);
    const threshold = parseInt(inputs[2].value);

    if (!itemName || isNaN(quantity) || isNaN(threshold)) {
      alert("è«‹å®Œæ•´å¡«å¯«åç¨±ã€åº«å­˜èˆ‡è­¦æˆ’å€¼");
      return;
    }

    // å–ç›®å‰æ˜¯å¦æœ‰_id (data-inventory-id)
    const inventoryId = itemCard.dataset.inventoryId || null;

    const payload = {
      item_name: itemName,
      quantity: quantity,
      threshold: threshold
    };

    // å¦‚æœæœ‰ idï¼Œä»£è¡¨ç·¨è¼¯ï¼Œå‘¼å«æ›´æ–°APIï¼Œå¦å‰‡å‘¼å«æ–°å¢API
    if (inventoryId) {
      payload.inventory_id = inventoryId;
      fetch("/api/supply/update_inventory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(res => res.json())
      .then(data => {
        if(data.success){
          alert("æ›´æ–°æˆåŠŸ");
          loadInventoryList();
        } else {
          alert("æ›´æ–°å¤±æ•—ï¼š" + data.msg);
        }
      });
    } else {
      fetch("/api/supply/add_inventory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(res => res.json())
      .then(data => {
        if(data.success){
          alert("æ–°å¢æˆåŠŸ");
          loadInventoryList();
        } else {
          alert("æ–°å¢å¤±æ•—ï¼š" + data.msg);
        }
      });
    }
  }

  function deleteItem(button) {
    const itemCard = button.closest(".item-card");
    const inventoryId = itemCard.dataset.inventoryId;
    if(inventoryId){
      if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨å“å—ï¼Ÿ")){
        return;
      }
      fetch("/api/supply/delete_inventory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({inventory_id: inventoryId})
      }).then(res => res.json())
      .then(data => {
        if(data.success){
          alert("åˆªé™¤æˆåŠŸ");
          loadInventoryList();
        } else {
          alert("åˆªé™¤å¤±æ•—ï¼š" + data.msg);
        }
      });
    } else {
      // å°šæœªå­˜åˆ°è³‡æ–™åº«ï¼Œç›´æ¥ç§»é™¤
      itemCard.remove();
    }
  }

  // é¡¯ç¤ºè©²é …ç›®ç´€éŒ„ï¼ˆå¯ä¾éœ€æ±‚è£œå……åŠŸèƒ½ï¼‰
  function showRecord(button) {
    alert("æ­¤åŠŸèƒ½å°šæœªå¯¦ä½œ");
  }

  // è¼‰å…¥ä½¿ç”¨è€…åº«å­˜åˆ—è¡¨ï¼Œå‹•æ…‹ç”¢ç”Ÿ item-card
  function loadInventoryList(){
    fetch("/api/supply/list_inventory")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("item-list");
      container.innerHTML = "";
      data.inventory.forEach(inv => {
        const div = document.createElement("div");
        div.className = "card mb-2 p-3 item-card";
        div.dataset.inventoryId = inv._id;
        div.innerHTML = `
          <div class="row align-items-center">
            <div class="col-5"><input type="text" class="form-control" value="${inv.item_name}"></div>
            <div class="col-3"><input type="number" class="form-control" value="${inv.quantity}"></div>
            <div class="col-2"><input type="number" class="form-control" value="${inv.threshold}"></div>
            <div class="col-2 text-end">
              
              <button class="btn btn-sm btn-success me-1" onclick="saveItem(this)">ğŸ’¾å„²å­˜</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(this)">âŒåˆªé™¤</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    });
  }

  // é é¢è¼‰å…¥æ™‚å–å¾—ç¾æœ‰åº«å­˜
  window.onload = function(){
    loadInventoryList();
  }

</script>
</body>
</html>