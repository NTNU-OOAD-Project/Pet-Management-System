<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸï¸ ç”¨å“å­˜è²¨ç´€éŒ„</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .item-card { min-height: 100px; }
    .hidden { display: none; }
    .wide-cell th, .wide-cell td { padding: 0.5rem 0.75rem; }
    .col-ratio-name { width: 25%; }
    .col-ratio-date { width: 25%; }
    .col-ratio-qty { width: 25%; }
    .col-ratio-note { width: 25%; }
  </style>
</head>
<body style="background-color: #f8f9fa;">

<div class="container py-5">
  <div class="row g-4">

    <!-- ğŸï¸ å·¥å…·åˆ—è¡¨ -->
    <div class="col-md-6">
      <div class="card shadow p-3 rounded-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">ğŸ“¦ ç”¨å“å­˜è²¨ç´€éŒ„</h5>
            <div class="col-5 text-end">
              <a href="{{ url_for('pets') }}" class="btn btn-sm btn-primary"><i class="fa-solid fa-house"></i> å›åˆ°æˆ‘çš„å¯µç‰©</a>
            </div>
          <div class="col-2">
            <button class="btn btn-sm btn-success" onclick="showAddPanel()">â• æ–°å¢</button>
          </div>
        </div>

        <div id="item-list">
          {% for r in inventory_list %}
            <div class="card p-3 mb-3 item-card">
              <div class="row align-items-center">
                <div class="col-3">
                  <input type="text" class="form-control" value="{{ r.item_name }}" readonly>
                </div>
                <div class="col-2">
                  <input type="text" class="form-control" value="{{ r.quantity }}" readonly>
                </div>
                <div class="col-3 d-flex align-items-center gap-2">
                  <input type="number"
                        class="form-control text-center"
                        id="threshold-{{ loop.index }}"
                        value="{{ r.threshold }}"
                        data-item="{{ r.item_name }}">
                  <button class="btn btn-sm btn-outline-primary"
                          onclick="submitThreshold('{{ loop.index }}')">
                    æ›´æ–°
                  </button>
                </div>
                <div class="col-3 text-end">
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="showRecord(this, '{{ r.item_name }}')">ç´€éŒ„</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteInventoryItem('{{ r.item_name }}', this)">åˆªé™¤</button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- ğŸ“‹ è©³ç´°ç´€éŒ„ -->
    <div class="col-md-6">
      <div class="card shadow p-3 rounded-4 hidden" id="record-panel">
        <h5 class="mb-3"><span id="record-item-name">é …ç›®åç¨±</span> çš„å­˜è²¨ç´€éŒ„</h5>
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th style="width: 30%;" class="col-ratio-date">æ—¥æœŸæ™‚é–“</th>
              <th style="width: 20%;" class="col-ratio-qty">æ•¸é‡</th>
              <th style="width: 30%;" class="col-ratio-note">å‚™è¨»</th>
              <th style="width: 19%;" >æ“ä½œ</th> <!-- æ–°å¢ -->
            </tr>
          </thead>
          <tbody id="record-table-body"></tbody>
        </table>
      </div>

      <!-- ğŸ“¥ æ–°å¢è¦–çª— -->
      <div class="card shadow p-3 rounded-4 hidden" id="add-panel">
        <h6>æ–°å¢å­˜è²¨ç´€éŒ„</h6>
        <table class="table table-bordered text-center wide-cell">
          <thead>
            <tr>
              <th class="col-ratio-name">åç¨±</th>
              <th class="col-ratio-date">æ—¥æœŸ</th>
              <th class="col-ratio-qty">æ•¸é‡</th>
              <th class="col-ratio-note">å‚™è¨»</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" class="form-control" id="new-item" placeholder="é …ç›®åç¨±"></td>
              <td><input type="date" class="form-control" id="new-date"></td>
              <td><input type="number" class="form-control" id="new-quantity" placeholder="æ•¸é‡"></td>
              <td><input type="text" class="form-control" id="new-note" placeholder="å‚™è¨»"></td>
            </tr>
          </tbody>
        </table>
        <div class="text-end">
          <button class="btn btn-sm btn-primary" onclick="addRecord()">æ–°å¢ç´€éŒ„</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  let itemId = 1;
  let currentItem = null;

  function showAddPanel() {
    document.getElementById("record-panel").classList.add("hidden");
    document.getElementById("add-panel").classList.remove("hidden");
  }

  function addRecord() {
    const dateStr = document.getElementById("new-date").value;
    const qty = document.getElementById("new-quantity").value;
    const name = document.getElementById("new-item").value;
    const note = document.getElementById("new-note").value;

    // çµ„åˆæˆ JSON è³‡æ–™
    const recordData = {
      user_id:"",
      item_name: name,
      time_str: dateStr,
      delta_quantity: parseInt(qty),
      reason: note
    };

    // ç™¼é€ POST è«‹æ±‚åˆ°å¾Œç«¯
    fetch("/api/supply/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(recordData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("âœ… æ–°å¢æˆåŠŸï¼");
        // å°‡è³‡æ–™åŠ åˆ°ç•«é¢ä¸­
        const tbody = document.getElementById("record-table-body");
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${dateStr}</td>
          <td>${qty}</td>
          <td>${note}</td>
        `;
        tbody.appendChild(row);

        // æ¸…ç©ºè¼¸å…¥æ¬„ä½
        document.getElementById("new-date").value = "";
        document.getElementById("new-quantity").value = "";
        document.getElementById("new-item").value = "";
        document.getElementById("new-note").value = "";
      } else {
        alert("âŒ æ–°å¢å¤±æ•—ï¼š" + data.msg);
      }
    });
  }

  function showRecord(button, itemName) {
    document.getElementById("add-panel").classList.add("hidden");
    document.getElementById("record-panel").classList.remove("hidden");
    document.getElementById("record-item-name").textContent = itemName;

    // æ¸…ç©ºèˆŠè³‡æ–™
    const tbody = document.getElementById("record-table-body");
    tbody.innerHTML = "";

    // ç™¼é€ GET è«‹æ±‚å¸¶ä¸Š item_nameï¼ˆç”¨ query stringï¼‰
    fetch(`/api/supply/records?item_name=${encodeURIComponent(itemName)}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          data.records.forEach(r => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${r.time_str}</td>
              <td>${r.delta_quantity}</td>
              <td>${r.reason}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${r._id}', this)">âŒ åˆªé™¤</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          alert("âŒ è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼š" + data.msg);
        }
      })
      .catch(err => {
        alert("ğŸš« éŒ¯èª¤ï¼š" + err);
      });
  }
  function deleteRecord(recordId, btn) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;

    fetch("/api/supply/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ record_id: recordId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // å¾ç•«é¢ç§»é™¤é€™ç­†è³‡æ–™æ‰€åœ¨çš„ row
        const row = btn.closest("tr");
        row.remove();
      } else {
        alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + data.msg);
      }
    })
    .catch(err => {
      alert("ğŸš« éŒ¯èª¤ï¼š" + err);
    });
  }

  function submitThreshold(index) {
    const input = document.getElementById(`threshold-${index}`);
    const itemName = input.getAttribute("data-item");
    const newThreshold = parseInt(input.value);

    if (isNaN(newThreshold) || newThreshold < 0) {
      alert("â—è«‹è¼¸å…¥æœ‰æ•ˆçš„éè² æ•´æ•¸ä½œç‚ºè­¦æˆ’å€¼");
      return;
    }

    fetch("/api/supply/adjust_threshold_full", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        item_name: itemName,
        new_threshold: newThreshold
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("âœ… è­¦æˆ’å€¼å·²æ›´æ–°");
      } else {
        alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + data.msg);
      }
    })
    .catch(err => alert("ğŸš« éŒ¯èª¤ï¼š" + err));
  }
  function deleteInventoryItem(itemName, btn) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${itemName}ã€å—ï¼Ÿ`)) return;

    fetch("/api/supply/delete_item", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ item_name: itemName })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // å¾ç•«é¢ä¸Šç§»é™¤è©²é …ç›®å¡ç‰‡ï¼ˆçˆ¶å±¤ cardï¼‰
        const card = btn.closest(".item-card");
        if (card) card.remove();
      } else {
        alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + data.msg);
      }
    })
    .catch(err => {
      alert("ğŸš« éŒ¯èª¤ï¼š" + err);
    });
  }
</script>
</body>
</html>
