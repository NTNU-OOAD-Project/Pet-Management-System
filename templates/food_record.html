<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>飲食管理 - 寵物日常管理系統</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="background-color: #e6f0ff;">
  <div class="container mt-5">
    <div class="card shadow p-4 rounded-4">
      <h2 class="mb-4 text-center">🐾 飲食管理紀錄</h2>

      <form id="foodForm">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>食品種類</th>
              <th>食用日期</th>
              <th>數量</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="food-table-body">
            {% for r in records %}
            <tr>
              <input type="hidden" name="pet_id[]" value="{{ pet_id }}">
              <input type="hidden" id="petId" value="{{ pet_id }}">
              <input type="hidden" name="record_id[]" value="{{ r._id }}">
              <td><input type="text" class="form-control" name="food_name[]" value="{{ r.food_name }}"></td>
              <td><input type="date" class="form-control" name="time_str[]" value="{{ r.time_str }}"></td>
              <td><input type="number" class="form-control" name="amount[]" value="{{ r.amount }}" min="1"></td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">刪除</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-outline-primary" onclick="addFoodRow()">➕ 新增食品紀錄</button>
          <button type="button" class="btn btn-primary" id="save-btn">儲存紀錄</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function addFoodRow() {
      const table = document.getElementById("food-table-body");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" class="form-control" name="food_name[]"></td>
        <td><input type="date" class="form-control" name="time_str[]"></td>
        <td><input type="number" class="form-control" name="amount[]" min="1"></td>
        <td>
          <input type="hidden" name="pet_id[]" value="{{  pet_id  }}">
          <input type="hidden" name="pet_id" value="{{  pet_id  }}">
          <input type="hidden" name="record_id[]" value="">
          <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">刪除</button>
        </td>
      `;
      table.appendChild(row);
    }

    function deleteRow(button) {
      button.closest("tr").remove();
      const row = button.closest("tr");
      const recordIdInput = row.querySelector('input[name="record_id[]"]');
      const recordId = recordIdInput?.value;

      if (!recordId) {
        row.remove();
        return;
      }

      if (!confirm("確定要刪除這筆資料嗎？")) return;

      fetch("/api/diet/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ record_id: recordId })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          row.remove();
        } else {
          alert("刪除失敗：" + result.msg);
        }
      })
      .catch(err => {
        alert("發生錯誤：" + err);
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById("save-btn").addEventListener("click", function (e) {
        alert("儲存按鈕被點擊");
        e.preventDefault();
        const rows = document.querySelectorAll('#food-table-body tr');
        updates = [];
        rows.forEach(row => {
          const food_name = row.querySelector('input[name="food_name[]"]');
          const time_str = row.querySelector('input[name="time_str[]"]');
          const amount = row.querySelector('input[name="amount[]"]');
          const record_id = row.querySelector('input[name="record_id[]"]');
          const pet_id = row.querySelector('input[name="pet_id[]"]');

          const entry = { 
            _id: record_id?.value,
            food_name: food_name?.value,
            time_str: time_str?.value,
            amount: amount?.value,
            pet_id: pet_id?.value
          };

          updates.push(entry);

        });
        const saveUrl = "{{ url_for('save_diet_records_batch') }}";
        fetch(saveUrl, {
          pet_id:"{{  pet_id  }}",
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ updates })
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert("儲存成功！");
            window.location.href = `/diet?pet_id=${result.pet_id}`;
          } else {
            alert("儲存失敗：" + result.msg);
          }
        });
      });
    });
  </script>
</body>
</html>