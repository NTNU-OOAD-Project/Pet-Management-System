<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„å¯µç‰© - PetSync</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    body {
      background: #dceeff;
    }
    .sidebar {
      width: 220px;
      background-color: #000;
      min-height: 100vh;
    }
    .main-content {
      background-color: transparent;
    }
    .card-title {
      font-weight: bold;
    }
    .icon-box {
      font-size: 2rem;
      color: #4a69bd;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- å´é‚Šæ¬„ -->
    <nav class="sidebar p-4">
      <div class="logo mb-4 text-white text-center">
        <i class="fa-solid fa-paw fa-2x mb-2"></i>
        <a href="{{ url_for('index') }}" class="logo-text d-block mb-2"><i class="fa-solid fa-paw me-2"></i>PetSync</a>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('login_page') }}"><i class="fa-solid fa-user me-2"></i>ç™»å…¥ / è¨»å†Š</a></li>
        <li class="nav-item"><a class="nav-link text-white active" href="{{ url_for('pets') }}"><i class="fa-solid fa-dog me-2"></i>æˆ‘çš„å¯µç‰©</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="pet_place.html"><i class="fa-solid fa-location-dot me-2"></i>å¯µç‰©å ´æ‰€</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('event') }}"><i class="fa-solid fa-calendar-days me-2"></i>å¯µç‰©æ´»å‹•</a></li>
      </ul>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <main class="main-content p-5 flex-grow-1">
      <div class="mb-3">
        <span class="fs-4">ä½ å¥½ï¼<strong>{{ session['user_name'] }}</strong>ï¼</span>
      </div>
      <div class="card shadow-lg p-4 rounded-4 border-0" style="background-color: #ffffffc7;">
        <div class="d-flex align-items-center mb-4">
          <h2 class="me-2"><strong>ğŸ¶ æˆ‘çš„å¯µç‰©åŠŸèƒ½é¸å–®</strong></h2>
          <button class="btn btn-success btn-sm" id="add-pet-btn" data-bs-toggle="modal" data-bs-target="#addPetModal">
            <i class="fa fa-plus"></i>
          </button>
        </div>
        <!-- å¯µç‰©ä¸‹æ‹‰é¸å–®èˆ‡ç·¨è¼¯ -->
        <div class="mb-4">
          <label class="me-2">ç›®å‰å¯µç‰©ï¼š</label>
          <select class="form-select d-inline-block w-auto" id="pet-select"></select>
          <button class="btn btn-primary btn-sm ms-2" id="edit-pet-btn" disabled>
            <i class="fa fa-edit"></i> ç·¨è¼¯
          </button>
        </div>
        <div class="row g-4">
          <!-- å¥åº·ç´€éŒ„ -->
          <div class="col-md-4" data-aos="zoom-in">
            <a href="health_record.html" class="card shadow-sm border-0 h-100 text-center p-3 text-decoration-none text-dark">
              <div class="icon-box mb-3"><i class="fa-solid fa-heartbeat"></i></div>
              <h5 class="card-title">å¥åº·ç´€éŒ„</h5>
              <p class="card-text">è¿½è¹¤ç–«è‹—ã€èº«é«”ç‹€æ³èˆ‡å¥åº·å ±å‘Šã€‚</p>
            </a>
          </div>
          <!-- é£²é£Ÿç®¡ç† -->
          <div class="col-md-4" data-aos="zoom-in" data-aos-delay="100">
            <a href="food_record.html" class="card shadow-sm border-0 h-100 text-center p-3 text-decoration-none text-dark">
              <div class="icon-box mb-3"><i class="fa-solid fa-bone"></i></div>
              <h5 class="card-title">é£²é£Ÿç®¡ç†</h5>
              <p class="card-text">è¨˜éŒ„æ¯æ—¥é£²é£Ÿèˆ‡åå¥½ï¼Œå»ºç«‹é¤µé£Ÿè¨ˆç•«ã€‚</p>
            </a>
          </div>
          <!-- ç…§è­·æé†’ -->
          <div class="col-md-4" data-aos="zoom-in" data-aos-delay="200">
            <a href="care_reminder.html" class="card shadow-sm border-0 h-100 text-center p-3 text-decoration-none text-dark">
              <div class="icon-box mb-3"><i class="fa-solid fa-bell"></i></div>
              <h5 class="card-title">ç…§è­·æé†’</h5>
              <p class="card-text">è¨­å®šæ´—æ¾¡ã€å‰ªæŒ‡ç”²ã€é©…èŸ²ç­‰å®šæœŸæé†’ã€‚</p>
            </a>
          </div>
          <!-- é†«ç™‚é ç´„ -->
          <div class="col-md-6" data-aos="zoom-in" data-aos-delay="300">
            <a href="#" id="medical-card" class="card shadow-sm border-0 h-100 text-center p-3 text-decoration-none text-dark">
              <div class="icon-box mb-3"><i class="fa-solid fa-hospital"></i></div>
              <h5 class="card-title">é†«ç™‚é ç´„</h5>
              <p class="card-text">å¿«é€Ÿå®‰æ’è¨ºç™‚æ™‚é–“ï¼Œä¸¦æŸ¥çœ‹é ç´„ç´€éŒ„ã€‚</p>
            </a>
          </div>
          <!-- ç”¨å“å­˜è²¨ -->
          <div class="col-md-6" data-aos="zoom-in" data-aos-delay="400">
            <a href="supply_inventory.html" class="card shadow-sm border-0 h-100 text-center p-3 text-decoration-none text-dark">
              <div class="icon-box mb-3"><i class="fa-solid fa-box-open"></i></div>
              <h5 class="card-title">ç”¨å“å­˜è²¨</h5>
              <p class="card-text">è¿½è¹¤é£¼æ–™ã€å°¿å¸ƒã€æ¸…æ½”ç”¨å“ç­‰å‰©é¤˜æ•¸é‡ã€‚</p>
            </a>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- æ–°å¢å¯µç‰© Modal -->
  <div class="modal fade" id="addPetModal" tabindex="-1" aria-labelledby="addPetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="add-pet-form">
          <div class="modal-header">
            <h5 class="modal-title" id="addPetModalLabel">æ–°å¢å¯µç‰©</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label>å¯µç‰©åç¨±</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
              <label>å“ç¨®</label>
              <input type="text" class="form-control" name="species" required>
            </div>
            <div class="mb-3">
              <label>å¹´é½¡</label>
              <input type="number" class="form-control" name="age" min="0" required>
            </div>
            <div class="mb-3">
              <label>å¥åº·ç‹€æ³</label>
              <select class="form-control" name="health_status" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="æ­£å¸¸">æ­£å¸¸</option>
                <option value="éœ€è¦é†«ç™‚">éœ€è¦é†«ç™‚</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-success">æ–°å¢</button>
          </div>
          <div id="add-pet-result" class="mt-2 ms-3"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å¯µç‰© Modal -->
  <div class="modal fade" id="editPetModal" tabindex="-1" aria-labelledby="editPetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="edit-pet-form">
          <div class="modal-header">
            <h5 class="modal-title" id="editPetModalLabel">ç·¨è¼¯å¯µç‰©è³‡è¨Š</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="pet_id" id="edit-pet-id">
            <div class="mb-3">
              <label>å¯µç‰©åç¨±</label>
              <input type="text" class="form-control" name="name" id="edit-pet-name" required>
            </div>
            <div class="mb-3">
              <label>å“ç¨®</label>
              <input type="text" class="form-control" name="species" id="edit-pet-species" required>
            </div>
            <div class="mb-3">
              <label>å¹´é½¡</label>
              <input type="number" class="form-control" name="age" id="edit-pet-age" min="0" required>
            </div>
            <div class="mb-3">
              <label>å¥åº·ç‹€æ³</label>
              <select class="form-control" name="health_status" id="edit-pet-health-status" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="æ­£å¸¸">æ­£å¸¸</option>
                <option value="éœ€è¦é†«ç™‚">éœ€è¦é†«ç™‚</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
          </div>
          <div id="edit-pet-result" class="mt-2 ms-3"></div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init();
    let petsData = [];

    async function loadPets() {
      const res = await fetch('/api/pets/list');
      const data = await res.json();
      if(data.success){
        petsData = data.pets;
        const select = document.getElementById('pet-select');
        select.innerHTML = '';
        petsData.forEach((pet, i) => {
          const opt = document.createElement('option');
          opt.value = pet.pet_id;
          opt.textContent = pet.name;
          select.appendChild(opt);
        });
        // é è¨­é¸ç¬¬ä¸€éš»
        if (petsData.length) {
          select.value = petsData[0].pet_id;
          document.getElementById('edit-pet-btn').disabled = false;
        } else {
          document.getElementById('edit-pet-btn').disabled = true;
        }
      }
    }
    loadPets();

    document.getElementById('pet-select').addEventListener('change', function(){
      document.getElementById('edit-pet-btn').disabled = !this.value;
    });

    document.getElementById('add-pet-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      const resp = await fetch('/api/pets/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const result = await resp.json();
      const resultDiv = document.getElementById('add-pet-result');
      if(result.success){
        resultDiv.innerHTML = `<span class="text-success">æ–°å¢æˆåŠŸï¼</span>`;
        this.reset();
        setTimeout(()=>{
          document.getElementById('add-pet-result').innerHTML = '';
          var addModal = bootstrap.Modal.getInstance(document.getElementById('addPetModal'));
          addModal.hide();
          loadPets();
        }, 1000);
      } else {
        resultDiv.innerHTML = `<span class="text-danger">${result.msg || 'æ–°å¢å¤±æ•—'}</span>`;
      }
    });

    // é»æ“Šç·¨è¼¯æŒ‰éˆ•ï¼Œå¸¶å‡ºå°æ‡‰å¯µç‰©è³‡è¨Š
    document.getElementById('edit-pet-btn').addEventListener('click', function(){
      const pet_id = document.getElementById('pet-select').value;
      const pet = petsData.find(p=>p.pet_id===pet_id);
      if(pet){
        document.getElementById('edit-pet-id').value = pet.pet_id;
        document.getElementById('edit-pet-name').value = pet.name;
        document.getElementById('edit-pet-species').value = pet.species;
        document.getElementById('edit-pet-age').value = pet.age;
        document.getElementById('edit-pet-health-status').value = pet.health_status;
        var editModal = new bootstrap.Modal(document.getElementById('editPetModal'));
        editModal.show();
      }
    });

    // æäº¤ç·¨è¼¯å¯µç‰©ï¼ˆupdate APIï¼‰
    document.getElementById('edit-pet-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const pet_id = document.getElementById('edit-pet-id').value;
      const data = {
        name: document.getElementById('edit-pet-name').value,
        species: document.getElementById('edit-pet-species').value,
        age: document.getElementById('edit-pet-age').value,
        health_status: document.getElementById('edit-pet-health-status').value
      };
      const resp = await fetch(`/api/pets/update/${pet_id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const result = await resp.json();
      const resultDiv = document.getElementById('edit-pet-result');
      if(result.success){
        resultDiv.innerHTML = `<span class="text-success">æ›´æ–°æˆåŠŸï¼</span>`;
        setTimeout(()=>{
          var editModal = bootstrap.Modal.getInstance(document.getElementById('editPetModal'));
          editModal.hide();
          loadPets();
        }, 1000);
      } else {
        resultDiv.innerHTML = `<span class="text-danger">${result.msg || 'æ›´æ–°å¤±æ•—'}</span>`;
      }
    });

    // æ ¹æ“špet_idè·³è½‰å¯µç‰©é†«ç™‚æœå‹™
    document.getElementById('medical-card').addEventListener('click', function(){
      const select = document.getElementById('pet-select');
      const pet_id = select.value;
      if (pet_id) {
        window.location.href = `/medical/view?pet_id=${pet_id}`;
      } else {
        alert("è«‹å…ˆé¸æ“‡ä¸€éš»å¯µç‰©ï¼");
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- AIæ™ºèƒ½åŠ©ç† -->
  <script src="/static/ai_assistant/core.js"></script>
</body>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
  AOS.init();
</script>
</html>
